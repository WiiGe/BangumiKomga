import json
from xml.etree.ElementTree import Element, SubElement, tostring
import xml.dom.minidom
from datetime import datetime
from tools.env import InitEnv


def generate_comic_info(json_data):
    # 创建根元素
    comic_info = Element('ComicInfo')
    comic_info.set('xmlns:xsd', 'http://www.w3.org/2001/XMLSchema')
    comic_info.set('xmlns:xsi', 'http://www.w3.org/2001/XMLSchema-instance')

    # 获取标题
    title = json_data['metadata']['title']

    # Title字段
    title_elem = SubElement(comic_info, 'Title')
    title_elem.text = title

    # Notes字段（使用文件最后修改时间）
    notes_elem = SubElement(comic_info, 'Notes')
    file_modified = datetime.strptime(
        json_data['fileLastModified'], '%Y-%m-%dT%H:%M:%SZ')
    notes_elem.text = f'Generated by BangumiKomga on {file_modified.isoformat()}'

    # 日期处理
    if json_data['metadata']['releaseDate']:
        release_date = datetime.strptime(
            json_data['metadata']['releaseDate'], '%Y-%m-%d')
        year_elem = SubElement(comic_info, 'Year')
        year_elem.text = str(release_date.year)

        month_elem = SubElement(comic_info, 'Month')
        month_elem.text = str(release_date.month)

        day_elem = SubElement(comic_info, 'Day')
        day_elem.text = str(release_date.day)

    # 作者信息
    # TODO: 将所有作者信息填入
    if json_data['metadata']['authors']:
        writer_elem = SubElement(comic_info, 'Writer')
        writer_elem.text = json_data['metadata']['authors'][0]['name']

    # 标签处理
    if json_data['metadata']['tags']:
        tags_elem = SubElement(comic_info, 'Tags')
        tags_elem.text = ','.join(json_data['metadata']['tags'])

    # 网络链接
    # TODO: 将所有链接填入
    if json_data['metadata']['links']:
        web_elem = SubElement(comic_info, 'Web')
        web_elem.text = json_data['metadata']['links'][0]['url']

    # 页数统计
    page_count_elem = SubElement(comic_info, 'PageCount')
    page_count_elem.text = str(json_data['media']['pagesCount'])

    # 语言设置
    # TODO: 根据文件名判断
    language_elem = SubElement(comic_info, 'LanguageISO')
    language_elem.text = 'zh'

    # 格式设置
    format_elem = SubElement(comic_info, 'Format')
    format_elem.text = 'Digital'

    # 漫画方向
    manga_elem = SubElement(comic_info, 'Manga')
    manga_elem.text = 'Yes'

    # 页面信息
    pages_elem = SubElement(comic_info, 'Pages')
    for i in range(1, json_data['media']['pagesCount'] + 1):
        page_elem = SubElement(pages_elem, 'Page')
        page_elem.set('Image', str(i))
        # FIXME: 尚无手段获取每页的具体尺寸
        # page_elem.set('ImageWidth', '1280')
        # page_elem.set('ImageHeight', '904')

    return comic_info


def prettify_comic_info(elem):
    """调整XML元素格式"""
    rough_string = tostring(elem, 'utf-8')
    reparsed = xml.dom.minidom.parseString(rough_string)
    return reparsed.toprettyxml(indent="  ")


def generate_eze_info(json_data):
    """
    将Komga的JSON转换为eze info.json格式
    """
    # 解析创建日期
    release_date = datetime.strptime(
        json_data['metadata']['releaseDate'], '%Y-%m-%d')

    # 提取链接信息
    links = json_data['metadata'].get('links', [])

    # 构建tags对象
    tags = {
        "tag": json_data['metadata'].get('tags', []),
        # FIXME: 假设固定值, 也许需要从文件名或其他字段确定原本的语言
        "language": [],
        # 假设固定值，可根据需要修改
        "category": ["manga"],
        "artist": [author['name'] for author in json_data['metadata']['authors']],
        "group": []  # komga似乎没有该字段, 也许该填Publisher? 或是删去
    }

    # 添加翻译状态
    # FIXME: 只是关注了 translated 字样, 也许需要从文件名或其他字段确定是否已经翻译
    if "translated" not in tags["tag"]:
        tags["tag"].append("translated")

    # 上传日期取元数据中的发布日期
    upload_date = [
        release_date.year,
        release_date.month,
        release_date.day,
    ]

    # 构建最终JSON结构
    return {
        "gallery_info": {
            "title": json_data['metadata']['title'],
            "title_original": json_data['name'],
            "link": links,
            "category": "manga",
            "tags": tags,
            "language": "chinese",  # 假设固定值中文
            "translated": True,
            "upload_date": upload_date,
            "source": {
                # FIXME: 尚未实现
            }
        }
    }


def generate_mylar_info(json_data):
    """
    将Komga的JSON转换为完整的series.json格式
    """

    # 提取基础信息
    metadata = json_data.get("metadata", {})
    books_metadata = json_data.get("booksMetadata", {})

    # 系列标题
    series_title = metadata.get("title") or json_data.get("name", "")

    # 出版商
    publisher = metadata.get("publisher") or ""

    # 年份 - 从发布日期或年份字段提取
    year = 2001  # 默认值
    release_date = books_metadata.get(
        "releaseDate") or metadata.get("releaseDate")
    if release_date and len(release_date) >= 4 and release_date[:4].isdigit():
        year = int(release_date[:4])
    elif metadata.get("year"):
        year = int(metadata.get("year"))

    # 简介 - 多源获取
    description = (metadata.get("summary") or
                   books_metadata.get("summary") or
                   metadata.get("description") or
                   "")

    # 状态映射
    komga_status = (metadata.get("status") or "").upper()
    mylar_status = {
        "ONGOING": "Continuing",
        "HIATUS": "Continuing",
        "ABANDONED": "Continuing",
        "ENDED": "Ended"
    }.get(komga_status, "Continuing")

    # 书籍总数
    total_issues = int(metadata.get("totalBookCount") or
                       json_data.get("booksCount") or
                       1)

    # 年龄评级标准化
    def normalize_age_rating(value):
        if value is None:
            return None
        if isinstance(value, str):
            value = value.strip().lower()
            if value.isdigit():
                value = int(value)
            else:
                return None
        if value <= 0:
            return "All"
        elif value < 12:
            return "9+"
        elif value < 15:
            return "12+"
        elif value < 17:
            return "15+"
        elif value < 18:
            return "17+"
        else:
            return "Adult"

    age_rating = normalize_age_rating(metadata.get("ageRating"))

    # 构建 Mylar3 series.json 格式
    mylar_data = {
        "version": "1.0.2",
        "metadata": {
            "type": "comicSeries",
            "publisher": publisher,
            "imprint": metadata.get("imprint"),
            "name": series_title,
            "comicid": int(metadata.get("comicId", 9527)),  # 默认值9527
            "year": year,
            "description_text": description.strip(),
            "description_formatted": None,  # 通常与description_text相同，但保留格式
            "volume": metadata.get("volume"),
            "booktype": metadata.get("bookType") or "Print",
            "age_rating": age_rating,
            "collects": metadata.get("collects"),  # TPB/GN收集信息
            "comic_image": metadata.get("comicImage") or "",  # 封面URL
            "total_issues": total_issues,
            "publication_run": metadata.get("publicationRun") or "",
            "status": mylar_status,
            # 额外字段（Mylar3 schema支持）
            "language": metadata.get("language"),
            "readingDirection": metadata.get("readingDirection"),
            "releaseDate": release_date,
            "authors": books_metadata.get("authors") or metadata.get("authors"),
            "links": metadata.get("links"),
            "alternateTitles": metadata.get("alternateTitles"),
            "genres": metadata.get("genres"),
            "tags": (metadata.get("tags") or
                     books_metadata.get("tags") or
                     json_data.get("tags")),
        }
    }


def save_comic_info_to_file(json_input):
    comic_xml = generate_comic_info(json_input)
    # 格式化输出
    xml_str = prettify_comic_info(comic_xml)
    # 保存到文件
    with open('ComicInfo.xml', 'w', encoding='utf-8') as f:
        f.write(xml_str)
    # 输出提示
    print(f"书籍 {json_input['id']} 的 ComicInfo.xml 已成功保存")


def save_eze_info_to_file(json_input):
    info_json = generate_eze_info(json_input)
    # 保存到文件
    with open('info.json', 'w', encoding='utf-8') as f:
        f.write(json.dumps(info_json, ensure_ascii=False))
    # 输出提示
    print(f"书籍 {json_input['id']} 的 info.json 已成功保存")


def save_mylar_info_to_file(json_input):
    info_json = generate_mylar_info(json_input)
    # 保存到文件
    with open('series.json', 'w', encoding='utf-8') as f:
        f.write(json.dumps(info_json, ensure_ascii=False))
    # 输出提示
    print(f"系列 {json_input['id']} 的 series.json 已成功保存")


if __name__ == '__main__':

    env = InitEnv()
    komga = env.komga
    book_json = komga.get_book_metadata("0JW1ZC34BJC62")
    save_comic_info_to_file(book_json)
    save_eze_info_to_file(book_json)
    series_json = komga.get_specific_series("0JR3CFZ42GMGT")
    save_mylar_info_to_file(series_json)
